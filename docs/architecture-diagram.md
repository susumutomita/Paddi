# Paddi システムアーキテクチャ

## 🏗️ 2つの実行モード

```
┌─────────────────────────────────────────────────────────────────────┐
│                           ユーザーの選択                              │
│                                                                     │
│        ローカル実行（プライバシー重視）    Cloud Run実行（利便性重視）   │
└─────────────┬──────────────────────────┬───────────────────────────┘
              │                          │
              ▼                          ▼
┌─────────────────────────┐  ┌─────────────────────────────────────┐
│    ローカル実行モード      │  │       Cloud Run実行モード            │
├─────────────────────────┤  ├─────────────────────────────────────┤
│                         │  │                                     │
│  [ユーザーPC/サーバー]    │  │        [Google Cloud Run]           │
│                         │  │                                     │
│  ┌─────────────────┐    │  │   ┌──────────────────────────┐     │
│  │   Python CLI    │    │  │   │    RESTful API Server   │     │
│  │   (main.py)     │    │  │   │      (web/app.py)       │     │
│  └────────┬────────┘    │  │   └────────────┬─────────────┘     │
│           │             │  │                │                   │
│  ┌────────▼────────┐    │  │   ┌────────────▼─────────────┐     │
│  │  Orchestrator   │    │  │   │   API Orchestrator      │     │
│  └────────┬────────┘    │  │   └────────────┬─────────────┘     │
│           │             │  │                │                   │
│  ┌────────▼────────────────────────────────▼─────────────┐     │
│  │              3つのエージェントパイプライン                │     │
│  ├──────────────────────────────────────────────────────┤     │
│  │                                                      │     │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐      │     │
│  │  │Collector │───▶│Explainer │───▶│Reporter  │      │     │
│  │  │ Agent    │    │  Agent   │    │  Agent   │      │     │
│  │  └──────────┘    └──────────┘    └──────────┘      │     │
│  │       │               │               │              │     │
│  └───────┼───────────────┼───────────────┼──────────────┘     │
│          │               │               │                     │
│  ┌───────▼────────┐ ┌────▼─────┐ ┌──────▼──────┐             │
│  │ Local Storage │ │Local LLM │ │   Output    │             │
│  │ (Mock Data)   │ │(将来対応) │ │  (MD/HTML)  │             │
│  └────────────────┘ └──────────┘ └─────────────┘             │
│                         │                                     │
└─────────────────────────┤  ┌─────────────────────────────────┘
                          │  │
                          │  │   ┌─────────────────────────┐
                          │  │   │   Google Cloud APIs    │
                          │  │   ├─────────────────────────┤
                          │  │   │ • Vertex AI (Gemini)   │
                          │  └──▶│ • IAM API              │
                          │      │ • Security Center API  │
                          │      │ • Cloud Logging API    │
                          │      └─────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  セキュリティ監査結果   │
              ├───────────────────────┤
              │ • 脆弱性レポート       │
              │ • 推奨事項           │
              │ • コンプライアンス状況 │
              └───────────────────────┘
```

## 📊 実行モード比較

### ローカル実行の特徴

```
[開発者/企業]
     │
     ▼
┌──────────────────────┐
│  1. git clone        │
│  2. pip install      │
│  3. python main.py   │
└──────────┬───────────┘
           │
     ┌─────▼─────┐
     │ 処理実行   │
     │ (完全ローカル)│
     └─────┬─────┘
           │
     ┌─────▼─────┐
     │ レポート生成│
     │ output/   │
     └───────────┘

メリット:
✅ データが外部に出ない
✅ カスタマイズ自由
✅ CI/CD統合容易
✅ コスト無料
```

### Cloud Run実行の特徴

```
[エンドユーザー]
     │
     ▼
┌──────────────────────┐
│  ブラウザでアクセス    │
│  認証・設定不要       │
└──────────┬───────────┘
           │
     ┌─────▼─────────┐
     │ Cloud Run     │
     │ (マネージド)    │
     └─────┬─────────┘
           │
     ┌─────▼─────────┐
     │ Vertex AI     │
     │ (高度な分析)   │
     └─────┬─────────┘
           │
     ┌─────▼─────┐
     │ Web UI    │
     │ Dashboard │
     └───────────┘

メリット:
✅ インストール不要
✅ AI機能フル活用
✅ すぐに使える
✅ 自動スケーリング
```

## 🔄 データフロー詳細

### 1. Collector Agent

```
入力源:
├── ローカル実行
│   └── Mock Data (JSON)
└── Cloud Run実行
    ├── Mock Data (デモ用)
    └── Real APIs (将来)
        ├── GCP APIs
        ├── GitHub APIs
        └── AWS APIs

出力:
└── collected.json
    ├── IAM Policies
    ├── Security Findings
    └── Audit Logs
```

### 2. Explainer Agent

```
分析エンジン:
├── ローカル実行
│   ├── ルールベース分析
│   └── Local LLM (将来)
└── Cloud Run実行
    └── Vertex AI (Gemini Pro)

出力:
└── explained.json
    ├── リスク評価
    ├── 重要度分類
    └── 改善提案
```

### 3. Reporter Agent

```
テンプレートエンジン:
└── Jinja2
    ├── report.md.j2
    ├── report.html.j2
    └── honkit.j2

出力形式:
├── Markdown (技術文書)
├── HTML (Web表示)
├── HonKit (ドキュメントサイト)
└── PDF (将来対応)
```

## 🚀 デプロイアーキテクチャ

### Cloud Runデプロイ

```
┌─────────────────────────────────────────────┐
│            Google Cloud Project             │
├─────────────────────────────────────────────┤
│                                             │
│  ┌─────────────┐    ┌──────────────────┐   │
│  │ Cloud Build │───▶│ Container Registry│   │
│  └─────────────┘    └────────┬─────────┘   │
│                              │              │
│                              ▼              │
│  ┌─────────────────────────────────────┐   │
│  │          Cloud Run Service          │   │
│  ├─────────────────────────────────────┤   │
│  │                                     │   │
│  │  ┌─────────────┐  ┌──────────────┐ │   │
│  │  │   Gunicorn  │  │  Flask App   │ │   │
│  │  │  (WSGI)     │──│  (REST API)  │ │   │
│  │  └─────────────┘  └──────────────┘ │   │
│  │                                     │   │
│  │  Environment Variables:             │   │
│  │  • USE_MOCK_DATA=true              │   │
│  │  • DEMO_MODE=true                  │   │
│  │  • LOG_LEVEL=INFO                  │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │        有効化されたAPI                │   │
│  ├─────────────────────────────────────┤   │
│  │ • Cloud Run API                    │   │
│  │ • Cloud Build API                  │   │
│  │ • Container Registry API           │   │
│  │ • Vertex AI API                    │   │
│  │ • IAM API                          │   │
│  │ • Security Command Center API      │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

## 🔐 セキュリティモデル

### 現在（ハッカソンデモ）

```
┌──────────────────┐
│  Public Access   │
│ (認証なし)        │
└────────┬─────────┘
         │
    ┌────▼────┐
    │ Mock    │
    │ Data    │
    │ Only    │
    └─────────┘
```

### 将来（本番環境）

```
┌────────────────────────────────┐
│     認証レイヤー                 │
├────────────────────────────────┤
│ • OAuth2 (Google/GitHub)       │
│ • Service Account              │
│ • API Key Management           │
└───────────┬────────────────────┘
            │
    ┌───────▼────────┐
    │ アクセス制御     │
    ├────────────────┤
    │ • Cloud IAM    │
    │ • RBAC         │
    │ • Audit Logs   │
    └────────────────┘
```

## 📈 スケーラビリティ

### 自動スケーリング設定

```yaml
Cloud Run Configuration:
  minInstances: 0      # コスト最適化
  maxInstances: 100    # 需要に応じて拡張
  cpu: 1               # 1 vCPU
  memory: 1Gi          # 1GB RAM
  timeout: 300s        # 5分タイムアウト
  
負荷分散:
  - Global Load Balancer
  - CDN統合（静的コンテンツ）
  - リージョン冗長性
```

## 🎯 ユースケース別アーキテクチャ

### 1. 個人開発者

```
開発者PC → ローカル実行 → レポート生成
         └─ Git連携 → CI/CD統合
```

### 2. 企業セキュリティチーム

```
セキュリティチーム → Cloud Run → Vertex AI分析
                └─ 定期実行 → Slack通知
```

### 3. ハッカソン審査

```
審査員 → ブラウザアクセス → デモ実行
      └─ API試用 → 機能確認
```